<!DOCTYPE html>
<html>
<head>
  <title>Math Quiz</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' https://raw.githubusercontent.com https://ui-avatars.com https://media.istockphoto.com https://w0.peakpx.com https://github.com data:; media-src https://raw.githubusercontent.com; connect-src 'self' https://raw.githubusercontent.com;">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/tab-icon.png">
  <style>
    /* Dark mode switch styles */
    .dark-mode-switch {
      display: inline-block;
      position: relative;
      width: 60px;
      height: 30px;
      border-radius: 15px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
    }
    body:not(.dark) .dark-mode-switch {
      background: url('https://media.istockphoto.com/id/1545193103/vector/cartoon-flat-style-white-clouds-on-blue.jpg?s=612x612&w=0&k=20&c=4V39Etf6jxDZ_Gw9V2w9UzEgEw7iQLq5Qb-1GJhBiOY=') center center;
    }
    body.dark .dark-mode-switch {
      background: url('https://w0.peakpx.com/wallpaper/249/688/HD-wallpaper-night-sky-black-stars.jpg') center center;
    }
    .dark-mode-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .dark-mode-switch label {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: left 0.3s ease, background 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    body:not(.dark) .dark-mode-switch label::after {
      content: "☀";
      color: #f39c12;
    }
    body.dark .dark-mode-switch label::after {
      content: "🌙";
      color: #f1c40f;
    }
    body.dark .dark-mode-switch label {
      left: 33px;
      background-color: #333;
    }
    .dark-toggle-container {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 10000;
    }
    
    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background: #f5f5f5;
      color: #2c3e50;
      min-height: 100vh;
      transition: background 0.3s ease, color 0.3s ease;
    }
    body.dark {
      background: #1e1e1e;
      color: #ccc;
    }
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #2980b9;
      color: white;
      text-align: center;
      padding: 15px 20px;
      font-size: 1.5em;
      z-index: 1000;
    }
    .wrapper {
      display: flex;
      margin-top: 70px;
      justify-content: center;
    }
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      bottom: 0;
      width: 300px;
      background: #fff;
      color: #2c3e50;
      padding: 20px;
      border-right: 1px solid #e0e0e0;
      transition: background 0.3s ease, color 0.3s ease;
      overflow-y: auto;
    }
    body.dark .sidebar {
      background: #2c2c2c;
      color: #ccc;
      border-right: 1px solid #444;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.2em;
      font-weight: 500;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar li {
      padding: 15px 10px;
      cursor: pointer;
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s ease;
    }
    .sidebar li:hover {
      background: #f0f0f0;
    }
    body.dark .sidebar li:hover {
      background: #3a3a3a;
    }
    .sidebar li.active {
      background: #f0f0f0;
      font-weight: 500;
    }
    body.dark .sidebar li.active {
      background: #555;
    }
    .sidebar li.locked {
      color: #999;
      cursor: not-allowed;
      opacity: 0.7;
      background: none;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      transition: background 0.3s ease, color 0.3s ease;
      flex: 1;
    }
    body.dark .container {
      background: #2c2c2c;
      color: #ccc;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 500;
    }
    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      background: #000;
      margin: 0 auto;
    }
    #videoFrame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    .quiz-section {
      background: #f8f8f8;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #e0e0e0;
    }
    body.dark .quiz-section {
      background: #444;
      border: 1px solid #666;
    }
    #question {
      font-size: 1.2em;
      margin-bottom: 15px;
      font-weight: 500;
    }
    .input-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    #answerInput {
      flex: 1;
      padding: 12px 20px;
      border: 2px solid #ccc;
      font-size: 16px;
      transition: all 0.2s ease;
    }
    #answerInput:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52,152,219,0.1);
    }
    button {
      padding: 12px 25px;
      background: #3498db;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #2980b9;
    }
    #score {
      text-align: center;
      font-size: 1.5em;
      margin-top: 30px;
      padding: 20px;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
    }
    body.dark #score {
      background: #3a3a3a;
      border: 1px solid #555;
    }
    #score:empty {
      display: none;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      margin: 20px 0;
    }
    .progress {
      height: 100%;
      background: #3498db;
      transition: width 0.3s ease;
    }
    @media (max-width: 900px) {
      .wrapper {
        flex-direction: column;
      }
      .sidebar {
        position: relative;
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        height: auto;
      }
      .sidebar li {
        padding: 10px;
        border-bottom: 1px solid #e0e0e0;
      }
      .container {
        margin: 20px;
        padding: 20px;
        margin-left: 0;
      }
      h1 {
        font-size: 1.5em;
      }
    }
    /* About Us Popup - Wider version */
    #aboutPopup {
      display: none;
      position: fixed;
      top: 70px;
      right: 10px;
      transform: translateX(0);
      background: white;
      padding: 20px;
      max-width: 600px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1001;
      font-size: 0.9em;
    }
    /* New Quagsire styles */
    #quagsireContainer {
      position: fixed;
      left: 300px; /* Just to the right of the sidebar */
      bottom: -240px; /* Only 20% visible initially (300px tall image => 60px visible) */
      cursor: pointer;
      z-index: 1100;
      transition: bottom 0.5s ease;
    }
    #quagsireContainer img {
      height: 300px; /* Bigger image */
    }
    #quagsireBubble {
      display: none;
      position: absolute;
      left: 70px;
      bottom: 100%; /* Position the bubble above the image */
      background: rgba(255,255,255,0.95);
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      font-size: 1em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      white-space: nowrap;
    }
    /* Leaderboard Styles */
    .leaderboard-container {
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
      background: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      border-radius: 8px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.dark .leaderboard-container {
      background: #2c2c2c;
      color: #ccc;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }

    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }

    body.dark .leaderboard-header {
      border-bottom: 1px solid #444;
    }

    .leaderboard-tabs {
      display: flex;
      gap: 10px;
    }

    .leaderboard-tab {
      padding: 8px 16px;
      background: #f0f0f0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    body.dark .leaderboard-tab {
      background: #3a3a3a;
      color: #ccc;
    }

    .leaderboard-tab.active {
      background: #3498db;
      color: white;
    }

    .leaderboard-content {
      position: relative;
    }

    #leaderboardTable {
      width: 100%;
      border-collapse: collapse;
    }

    #leaderboardTable th, 
    #leaderboardTable td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    body.dark #leaderboardTable th,
    body.dark #leaderboardTable td {
      border-bottom: 1px solid #444;
    }

    #leaderboardTable th {
      font-weight: 600;
      color: #555;
    }

    body.dark #leaderboardTable th {
      color: #aaa;
    }

    #leaderboardTable tr:nth-child(even) {
      background-color: #f8f8f8;
    }

    body.dark #leaderboardTable tr:nth-child(even) {
      background-color: #333;
    }

    .leaderboard-loading,
    .leaderboard-error {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    body.dark .leaderboard-loading,
    body.dark .leaderboard-error {
      color: #aaa;
    }

    .leaderboard-error {
      color: #e74c3c;
      display: none;
    }

    .rank-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      color: white;
      font-weight: 600;
    }

    .rank-1 {
      background: #f1c40f;
    }

    .rank-2 {
      background: #bdc3c7;
    }

    .rank-3 {
      background: #cd7f32;
    }

    .rank-other {
      background: #3498db;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .player-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="images/icon.png" alt="Turtle Icon" style="height:30px; vertical-align:middle; margin-right:10px;"> DrippyTurtle Academy
    <span id="aboutUsLink" style="cursor:pointer; float:right; margin-left:20px; color:white; text-decoration:underline; font-size:0.85em;">About Us</span>
  </div>
  <div id="aboutPopup">
    <p style="margin-bottom:15px;">Contributors:</p>
    <div style="display:flex; flex-direction:column; gap:15px; margin-bottom:15px;">
      <div style="display:flex; align-items:center; gap:15px;">
        <img src="images/boda.png" style="height:40px; width:40px; border-radius:50%;">
        <span style="padding-right:20px;">Alvin Ip</span>
      </div>
      <div style="display:flex; align-items:center; gap:15px;">
        <img src="images/drippyturtle.png" style="height:40px; width:40px; border-radius:50%;">
        <span style="padding-right:20px;">Jonathan He</span>
      </div>
      <div style="display:flex; align-items:center; gap:15px;">
        <img src="images/snom.png" style="height:40px; width:40px; border-radius:50%;">
        <span style="padding-right:20px;">Robert Wang</span>
      </div>
    </div>
    <button onclick="closeAboutPopup()" style="margin-top:15px;">Close</button>
  </div>
  <div id="quagsireContainer">
    <img id="quagsireImg" src="images/quagsire.png" alt="Quagsire">
    <div id="quagsireBubble">Keep going, you're doing great!</div>
  </div>
  <div class="wrapper">
    <div class="sidebar">
      <h2 id="sidebarTitle">6 Units - 0% Completed</h2>
      <ul>
        <li onclick="loadVideo(sidebarMapping[0])" id="sidebarItem0">What is an exponent?</li>
        <li onclick="loadVideo(sidebarMapping[1])" id="sidebarItem1">Multiplying Exponents!</li>
        <li onclick="loadVideo(sidebarMapping[2])" id="sidebarItem2">Dividing Exponents!</li>
        <li onclick="loadVideo(sidebarMapping[3])" id="sidebarItem3">Try This!</li>
        <li onclick="loadVideo(sidebarMapping[4])" id="sidebarItem4">Power of a Power!</li>
        <li onclick="loadVideo(sidebarMapping[5])" id="sidebarItem5">Exponent of One and Exponent of Zero!</li>
        <li onclick="loadVideo(sidebarMapping[6])" id="sidebarItem6">Exponent of Negative Exponents!</li>
        <li onclick="loadVideo(sidebarMapping[7])" id="sidebarItem7">Additional Question</li>
        <li onclick="loadVideo(sidebarMapping[8])" id="sidebarItem8">Final Quiz Q1</li>
        <li onclick="loadVideo(sidebarMapping[9])" id="sidebarItem9">Final Quiz Q2</li>
        <li onclick="loadVideo(sidebarMapping[10])" id="sidebarItem10">Final Quiz Q3</li>
      </ul>
    </div>
    <div class="container">
      <h1>Exponent Laws</h1>
      <div class="progress-bar">
        <div class="progress" id="progress"></div>
      </div>
      <div class="video-container">
        <video id="videoFrame" controls style="width: 100%; height: auto;"></video>
      </div>
      <div class="quiz-section">
        <p id="question"></p>
        <div class="input-group">
          <input type="text" id="answerInput" placeholder="Enter your answer here...">
          <button onclick="checkAnswer()">Submit</button>
        </div>
        <div id="feedback" style="margin-top:10px; font-size:14px;"></div>
      </div>
      <div id="nonQuizSection" style="display:none; text-align:center; margin:20px 0 0 0;">
        <button onclick="goToNextVideo()">Next</button>
      </div>
      <div id="navButtons" style="text-align:center; margin:20px 0;">
        <button onclick="backButton()"><<</button>
        <button onclick="forwardButton()">>></button>
      </div>
      <div id="score"></div>
    </div>
  </div>
  <!-- Global Leaderboard Section -->
  <div class="leaderboard-container">
    <div class="leaderboard-header">
      <h2>Global Leaderboard</h2>
      <div class="leaderboard-tabs">
        <button id="allTimeTab" class="leaderboard-tab active" onclick="switchLeaderboardTab('allTime')">All Time</button>
        <button id="weeklyTab" class="leaderboard-tab" onclick="switchLeaderboardTab('weekly')">Weekly</button>
      </div>
    </div>
    <div class="leaderboard-content">
      <table id="leaderboardTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody id="leaderboardList"></tbody>
      </table>
      <div id="leaderboardLoading" class="leaderboard-loading">Loading leaderboard data...</div>
      <div id="leaderboardError" class="leaderboard-error"></div>
    </div>
  </div>
  <div class="dark-toggle-container">
    <div class="dark-mode-switch">
      <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
      <label for="darkModeToggle"></label>
    </div>
  </div>
  <script>
    // Load progress from localStorage if it exists.
    function loadProgress() {
      const stored = localStorage.getItem('quizProgress');
      if (stored) {
        const progress = JSON.parse(stored);
        maxUnlocked = progress.maxUnlocked || 1;
        currentVideo = progress.currentVideo || 0;
        totalTries = progress.totalTries || 0;
        totalTime = progress.totalTime || 0;
      }
    }
  
    // Save current progress to localStorage.
    function saveProgress() {
      const progress = {
        maxUnlocked,
        currentVideo,
        totalTries,
        totalTime
      };
      localStorage.setItem('quizProgress', JSON.stringify(progress));
    }
  
    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }
    function submitScore(name, score) {
      // Validate inputs
      if (!name || typeof name !== 'string' || name.length > 50) {
        console.error('Invalid name provided');
        return;
      }
  
      if (!score || isNaN(score) || score < 0) {
        console.error('Invalid score provided');
        return;
      }
  
      // Add CSRF protection if your backend supports it
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  
      fetch('https://your-vercel-project.vercel.app/api/scores', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          name: name.trim(), 
          score: Math.floor(score),
          timestamp: new Date().toISOString()
        })
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            console.log('Score submitted successfully');
            // Reload the leaderboard to show the updated scores
            loadLeaderboard();
          } else {
            console.error('Error submitting score:', data.error);
          }
        })
        .catch(error => {
          console.error('Fetch error:', error);
        });
    }
    function closeAboutPopup() {
      document.getElementById('aboutPopup').style.display = 'none';
    }
    document.getElementById('aboutUsLink').addEventListener('click', function(event) {
      const popup = document.getElementById('aboutPopup');
      event.stopPropagation();
      popup.style.display = (popup.style.display === 'none' || popup.style.display === '') ? 'block' : 'none';
    });
    document.addEventListener('click', function(event) {
      const popup = document.getElementById('aboutPopup');
      const aboutUsLink = document.getElementById('aboutUsLink');
      if (popup.style.display === 'block' && !popup.contains(event.target) && event.target !== aboutUsLink) {
        popup.style.display = 'none';
      }
    });
    const quagsireMessages = [
      "Keep going, you're doing great!",
      "You got this!",
      "Believe in yourself!",
      "Almost there, stay strong!",
      "Quack"
    ];
    document.getElementById('quagsireContainer').addEventListener('click', function(event) {
      const container = document.getElementById('quagsireContainer');
      const bubble = document.getElementById('quagsireBubble');
      const msg = quagsireMessages[Math.floor(Math.random() * quagsireMessages.length)];
      bubble.textContent = msg;
      container.style.bottom = "-120px";
      bubble.style.display = 'block';
      setTimeout(() => {
        container.style.bottom = "-240px";
        bubble.style.display = 'none';
      }, 2000);
      event.stopPropagation();
    });
    const videos = [
      { id: 'INTRO1', isQuiz: false },
      { id: 'INTRO2', isQuiz: false },
      { id: 'QUIZ2', question: 'What is the answer', answer: 'te', tries: 0, isQuiz: true },
      { id: 'INTRO3', isQuiz: false },
      { id: 'QUIZ3', question: 'What is the answer', answer: 'answer3', tries: 0, isQuiz: true },
      { id: 'POP1', question: 'Answer this standalone question.', answer: 'standalone', tries: 0, isQuiz: true },
      { id: 'INTRO4', isQuiz: false },
      { id: 'QUIZ4', question: 'What is the answer?', answer: 'answer4', tries: 0, isQuiz: true },
      { id: 'INTRO5', isQuiz: false },
      { id: 'QUIZ5', question: 'What is the answer?', answer: 'answer5', tries: 0, isQuiz: true },
      { id: 'INTRO6', isQuiz: false },
      { id: 'QUIZ6', question: 'What is the answer?', answer: 'answer6', tries: 0, isQuiz: true },
      { id: 'POP2', question: 'Additional Question: What is 5 + 3?', answer: '8', tries: 0, isQuiz: true },
      { id: 'FINALQ1_ID', question: 'Final Quiz Question 1: What is 2^3?', answer: '8', tries: 0, isQuiz: true },
      { id: 'FINALQ2_ID', question: 'Final Quiz Question 2: Simplify 2^4 * 2^3.', answer: '128', tries: 0, isQuiz: true },
      { id: 'FINALQ3_ID', question: 'Final Quiz Question 3: What is (2^3)^2?', answer: '64', tries: 0, isQuiz: true }
    ];
    const sidebarMapping = [0, 1, 4, 5, 7, 9, 11, 12, 13, 14, 15];
    let maxUnlocked = 1;
    let currentVideo = 0;
    let totalTries = 0;
    let startTime = Date.now();
    let totalTime = 0;
  
    loadProgress();
  
    function initialize() {
      if (currentVideo > 0) {
        updateProgress();
      } else {
        document.getElementById('progress').style.width = '0%';
        document.getElementById('sidebarTitle').textContent = '6 Units - 0% Completed';
      }
      const videoFrame = document.getElementById('videoFrame');
      videoFrame.pause();
      // Use raw.githubusercontent.com links for the videos.
      videoFrame.src = `https://raw.githubusercontent.com/DeoTime/images.storage/main/${videos[currentVideo].id}.mp4`;
      videoFrame.currentTime = 0;
      videoFrame.load();
      videoFrame.play().catch((error) => {
        console.log("Auto-play prevented:", error);
      });
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').blur();
      document.getElementById('feedback').textContent = '';
      if (videos[currentVideo].isQuiz) {
        document.querySelector('.quiz-section').style.display = 'block';
        document.getElementById('nonQuizSection').style.display = 'none';
        document.getElementById('question').textContent = videos[currentVideo].question;
        document.getElementById('answerInput').focus();
      } else {
        document.querySelector('.quiz-section').style.display = 'none';
        document.getElementById('nonQuizSection').style.display = 'block';
        if (currentVideo < videos.length - 1) {
          maxUnlocked = Math.max(maxUnlocked, currentVideo + 1);
        }
      }
      updateSidebarActive();
      saveProgress(); // Save progress after initialization
    }
    function checkAnswer() {
      if (!videos[currentVideo].isQuiz) return;
      const userAnswer = document.getElementById('answerInput').value.toLowerCase().trim();
      const correctAnswer = videos[currentVideo].answer;
      const feedback = document.getElementById('feedback');
      videos[currentVideo].tries++;
      if (userAnswer === correctAnswer) {
        feedback.textContent = "Correct!";
        feedback.style.color = "green";
        totalTries += videos[currentVideo].tries;
        totalTime += (Date.now() - startTime);
        if (currentVideo < videos.length - 1) {
          maxUnlocked = Math.max(maxUnlocked, currentVideo + 1);
        }
        setTimeout(() => {
          feedback.textContent = "";
          goToNextVideo();
        }, 1500);
      } else {
        feedback.textContent = "Incorrect, try again.";
        feedback.style.color = "red";
        document.getElementById('answerInput').value = '';
        document.getElementById('answerInput').focus();
      }
      saveProgress(); // Save progress after checkAnswer
    }
    function goToNextVideo() {
      if (currentVideo < videos.length - 1) {
        if (currentVideo + 1 > maxUnlocked) {
          alert("This video is locked. Please complete the previous section first.");
          return;
        }
        currentVideo++;
        startTime = Date.now();
        if (videos[currentVideo].isQuiz) {
          videos[currentVideo].tries = 0;
        }
        initialize();
      } else {
        endQuiz();
      }
    }
    function endQuiz() {
      const totalSeconds = Math.floor(totalTime / 1000);
      const score = calculateScore(totalSeconds, totalTries);
      document.querySelector('.quiz-section').style.display = 'none';
      document.getElementById('nonQuizSection').style.display = 'none';
      document.getElementById('score').innerHTML = `<h2>Quiz Complete! 🏆</h2>
        <p>⏱ Time: ${totalSeconds} seconds</p>
        <p>🎯 Total Attempts: ${totalTries}</p>
        <p style="font-size:1.8em; margin-top:15px;">⭐ Final Score: ${score}</p>
        <div style="margin-top:20px;">
          <input type="text" id="playerNameInput" placeholder="Enter your name" style="padding:10px; margin-right:10px;">
          <button onclick="submitPlayerScore()">Submit to Leaderboard</button>
        </div>`;
      saveProgress();
    }

    // Add this new function to handle score submission
    function submitPlayerScore() {
      const playerName = document.getElementById('playerNameInput').value.trim();
      if (!playerName) {
        alert('Please enter your name to submit your score');
        return;
      }
  
      const totalSeconds = Math.floor(totalTime / 1000);
      const score = calculateScore(totalSeconds, totalTries);
  
      submitScore(playerName, score);
  
      // Disable the input and button after submission
      document.getElementById('playerNameInput').disabled = true;
      document.getElementById('playerNameInput').nextElementSibling.disabled = true;
      document.getElementById('playerNameInput').nextElementSibling.textContent = 'Score Submitted!';
    }
    function calculateScore(time, attempts) {
      const timePenalty = time * 5;
      const attemptPenalty = attempts * 50;
      return Math.max(0, 1000 - timePenalty - attemptPenalty);
    }
    function updateProgress() {
      const progress = (maxUnlocked / (videos.length - 1)) * 100;
      document.getElementById('progress').style.width = `${progress}%`;
      document.getElementById('sidebarTitle').textContent = `6 Units - ${Math.floor(progress)}% Completed`;
    }
    function loadVideo(index) {
      if (index > maxUnlocked) {
        alert('This video is locked. Please complete the previous section first.');
        return;
      }
      currentVideo = index;
      startTime = Date.now();
      if (videos[currentVideo].isQuiz) {
        videos[currentVideo].tries = 0;
      }
      document.getElementById('score').innerHTML = '';
      initialize();
      saveProgress();
    }
    function updateSidebarActive() {
      const items = document.querySelectorAll('.sidebar li');
      items.forEach((item, i) => {
        if (!item.dataset.title) {
          item.dataset.title = item.textContent;
        }
        const original = item.dataset.title;
        let icon = "";
        const vidIndex = sidebarMapping[i];
        if (vidIndex < currentVideo && videos[vidIndex] && videos[vidIndex].isQuiz) {
          icon = videos[vidIndex].tries === 1 ? " ⭐" : " ✔";
        }
        item.textContent = original + icon;
        item.classList.toggle('active', vidIndex === currentVideo);
        if (vidIndex > maxUnlocked) {
          item.classList.add('locked');
          item.onclick = () => alert('This video is locked. Please complete the previous section first.');
        } else {
          item.classList.remove('locked');
          item.onclick = () => loadVideo(vidIndex);
        }
      });
    }
    function backButton() {
      if (currentVideo > 0) {
        currentVideo--;
        startTime = Date.now();
        if (videos[currentVideo].isQuiz) {
          videos[currentVideo].tries = 0;
        }
        initialize();
        saveProgress();
      } else {
        alert("No previous video.");
      }
    }
    function forwardButton() {
      goToNextVideo();
    }
    document.getElementById('answerInput').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        checkAnswer();
      }
    });
    document.addEventListener('keydown', function(event) {
      if (document.activeElement.id !== 'answerInput') {
        if (event.key === 'ArrowLeft') {
          event.preventDefault();
          backButton();
        } else if (event.key === 'ArrowRight') {
          event.preventDefault();
          forwardButton();
        }
      }
    });
  
    // Global Leaderboard: Load leaderboard data with improved security and error handling
    function loadLeaderboard(timeFrame = 'allTime') {
      const leaderboardList = document.getElementById('leaderboardList');
      const loadingElement = document.getElementById('leaderboardLoading');
      const errorElement = document.getElementById('leaderboardError');
  
      // Show loading state
      leaderboardList.innerHTML = '';
      loadingElement.style.display = 'block';
      errorElement.style.display = 'none';
  
      // Update the URL to point to your leaderboard.json file on GitHub
      // Using a versioned URL is more secure than using 'main' branch
      const url = 'https://your-vercel-project.vercel.app/api/leaderboard?timeFrame=' + timeFrame;
  
      fetch(url, { 
        cache: 'no-store',  // Don't cache results to always get fresh data
        headers: {
          'Accept': 'application/json'
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Network error: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          try {
            // Validate data structure
            if (!Array.isArray(data.leaderboard?.contributors)) {
              throw new Error('Invalid leaderboard data format');
            }
  
            // Filter data based on timeFrame if needed
            let filteredData = [...data.leaderboard.contributors];
  
            if (timeFrame === 'weekly') {
              // Filter for entries within the last 7 days
              const oneWeekAgo = new Date();
              oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  
              // This assumes your data has a 'date' field
              // If not, you'll need to adjust this logic
              filteredData = filteredData.filter(entry => {
                if (!entry.date) return true; // Include entries without dates for now
                return new Date(entry.date) >= oneWeekAgo;
              });
            }
  
            // Sort entries in descending order (highest score first)
            filteredData.sort((a, b) => b.score - a.score);
  
            // Hide loading state
            loadingElement.style.display = 'none';
  
            // Display the leaderboard
            if (filteredData.length === 0) {
              leaderboardList.innerHTML = '<tr><td colspan="4" style="text-align:center;">No data available for this time period</td></tr>';
              return;
            }
  
            filteredData.forEach((entry, index) => {
              const rank = index + 1;
              const tr = document.createElement('tr');
  
              // Rank column with badge
              const rankTd = document.createElement('td');
              const rankBadge = document.createElement('div');
              rankBadge.className = `rank-badge rank-${rank <= 3 ? rank : 'other'}`;
              rankBadge.textContent = rank;
              rankTd.appendChild(rankBadge);
  
              // Player column with avatar
              const playerTd = document.createElement('td');
              const playerInfo = document.createElement('div');
              playerInfo.className = 'player-info';
  
              const avatar = document.createElement('img');
              avatar.className = 'player-avatar';
              avatar.src = entry.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(entry.username)}&background=random`;
              avatar.alt = entry.username;
  
              const playerName = document.createElement('span');
              playerName.textContent = entry.username;
  
              playerInfo.appendChild(avatar);
              playerInfo.appendChild(playerName);
              playerTd.appendChild(playerInfo);
  
              // Score column
              const scoreTd = document.createElement('td');
              scoreTd.textContent = entry.score.toLocaleString();
  
              tr.appendChild(rankTd);
              tr.appendChild(playerTd);
              tr.appendChild(scoreTd);
  
              leaderboardList.appendChild(tr);
            });
          } catch (error) {
            console.error('Error processing leaderboard data:', error);
            errorElement.textContent = 'Error processing leaderboard data. Please try again later.';
            errorElement.style.display = 'block';
            loadingElement.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error loading leaderboard:', error);
          errorElement.textContent = 'Error loading leaderboard. Please try again later.';
          errorElement.style.display = 'block';
          loadingElement.style.display = 'none';
        });
    }
  
    // Function to switch between leaderboard tabs
    function switchLeaderboardTab(tab) {
      // Update active tab styling
      document.getElementById('allTimeTab').classList.toggle('active', tab === 'allTime');
      document.getElementById('weeklyTab').classList.toggle('active', tab === 'weekly');
  
      // Load the appropriate leaderboard data
      loadLeaderboard(tab);
    }
  
    initialize();
    loadLeaderboard();
  </script>
</body>
</html>

